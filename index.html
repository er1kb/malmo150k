<!DOCTYPE html>
<html>

   <head>
   <meta charset="UTF-8">



<script src='js/Tangle-0.1.0/Tangle.js' type='text/javascript'></script>
<link rel="stylesheet" href='js/Tangle-0.1.0/TangleKit/TangleKit.css' type='text/css'></style>
<script src='js/Tangle-0.1.0/TangleKit/mootools.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/sprintf.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/BVTouchable.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/TangleKit.js' type='text/javascript'></script>
<script src='js/d3/d3.min.js'></script>
<script src='js/crossfilter.min.js'></script>
<script src='js/helpers.js'></script>
<!-- <script src='js/dc.js-2.0.0-beta.19/dc.min.js'></script> -->



<style type='text/css'>


#controls {
    position: absolute;
    left: 300px;    
    width: 800px;
    height: 400px;
    font-size: 24px;
    text-align: left; 
    margin-left:0px;
    margin-right:0px;
    margin-top:20px;
    margin-bottom:-20px;
    font-size: 26px;    
}


#timeline {
    position: absolute;
    width: 0px;
    height: 20px;
    border: none;
/*    border-radius: 15px; */
    background-color: lightgreen;
}

#yearChart {
    position: absolute;
    top: 400px;
    height: 100px;
    width: 800px;
    left: 0px;    
}

#svg {
    display: inline;
    position: absolute;
    width: 800px;
    height: 600px;  
    left: 150px;
    top: 500px;
    background-color: white;
    
//    background-image: url(bg.png);
    background-position: left top;
    background-size: 800px 560px;
    background-repeat: no-repeat;    
}


#ageChart {
    position: absolute;
    height: 600px;
    width: 150px;  
    left: 0px;
    top: 0px;
    background-color: white;
}

.widget {
    position: relative;
    margin-top: 0px;
    width: 800px;
    height: 600px;
    /* font-family: Serif, Georgia; */
    font-size: 22px;
}


/* .widget:hover { */
/*     background-color: #e0e0e0; */
/* } */

indicatorBar {
    background-color: #b5b5b5;
}

#increase {
    color: green;
}

#decrease {
    color: red;
}

.TKAdjustableNumber {
    color: #00b5e2;
    font-weight: bold;
}

.TKAdjustableNumberHelp {
    color: #00b5e2;
    font-size: 18px;
}

.selector {
    line-height: 40px;
    text-align: center;
}

.selector > * {
    margin-left: 0px;
    margin-right: 10px;
}


.selectorItem {
    border: none;
    border-radius: 15px; 
    font-size: 24px;
    padding-left: 15px;
    padding-right: 10px;
    cursor: pointer;
    }
    
.selector:hover {
    
}    

.hide {
    background-color: rgba(224,224,224,0.6);
    color: #b5b5b5;    
}

.hide:hover {
    background-color: rgba(224,224,224,0.8);
}

.show {
    background-color: rgba(0,181,226,0.4);       
}

.show:hover {
    background-color: rgba(0,181,226,0.8);       
}

.xAxis path {
    fill: none;
    stroke: none;
}


.xAxis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.xAxis text {
    font-family: sans-serif;
    font-size: 11px;
}


.brush .extent {
  stroke: #000;
  fill-opacity: .125;
  fill: #b5b5b5;
  shape-rendering: crispEdges;
}

.resize {
    width: 10px;
    height: 150px;
    fill: purple;
    fill-opacity: 0.3;
}


#widgetContainer {
    position: absolute;
    width: 800px;
    height: 600px;  
    left: 300px;
    top: 550px;
    background-color: khaki;
}

#inactive {
    visibility: hidden;
    height: 0px;
}

</style>








<script type='text/javascript'>







var outerWidth = 500,
    outerHeight = 400,
    margin = {top: 30, right: 30, bottom: 50, left: 50},
    width = outerWidth - margin.left - margin.right,
    height = outerHeight - margin.top - margin.bottom;





var update = function(houseData, maxHouses){



var svgHeight = 500;


var housePoints = [[100,50], [100,150], [80,150], [150,200],
                  [220,150], [200,150], [200,50], [100,50]];

console.log('number of houses => ' + houseData.length);

var transitionTime = 30;

var houseScaleX = d3.scale.linear().domain([1,maxHouses]).range([0,500]);  //---//
//d3.select('#svg').selectAll('polygon').remove();

var house = d3.select('#svg').selectAll('polygon')
                            .data(houseData, function(d,i) { return d; });
                            
                        house
                            .enter()
                            .append("polygon")
                            .attr("points", housePoints.map(function(d) { 
                                    var x = d[0],
                                    y = svgHeight - d[1] + 100;
                                    return [x,y]; }))                                  
                            .attr("stroke", "black")
                            .attr("stroke-width", 1)
                            .attr("fill", "#00b5e2")
                            .attr("transform", function(d,i) { return "translate(" + (houseScaleX(d)) + ")"; })
                            .attr('n', function(d,i) { return i; })
                            .style('fill', 'Bisque');                               
                             
                            
                        house.exit()
                            .transition().duration(transitionTime * 5)
                            .style('fill', 'orange')
                            .style('fill-opacity', 0)
                            .style('stroke-opacity', 0)
                            .remove();

   }



</script>

   </head>
  <!-- <body onload="setUpTangle()"> -->
  <body>




    <div id="inactive">

    <!-- Productivity -->
    <p id="productivityWidget" class="widget">
         <span data-var="nProductivePart"></span> fler i åldrarna 20-64 innebär att 
         <span data-var="shareProductivePart" data-format="%.1f">%</span> av de nya malmöborna 
         <span data-var='start'></span> - <span data-var='end'></span> är i yrkesverksam ålder. 
         Om vi räknar på de nya malmöborna utan att ta hänsyn till befintlig befolkning så är försörjningskvoten 
         <span data-var="dependencyRatio"></span>. Detta är det antal personer varje 
        individ i yrkesverksam ålder måste försörja, inklusive sig själv. Att en relativt stor del 
        av tillväxten sker i de icke yrkesverksamma åldrarna innebär att dagens försörjningskvot 
        (1,60) väntas öka till 1,66 år 2025 och ... år 2040. Det ställer krav på sysselsättningen och ökar  
        vikten av att den som kan jobba också ges möjlighet att göra det. 
    </p>
    <!-- /Productivity -->


    <!-- Housing -->
    <p id="housingWidget" class="widget">
         <span data-var="nPeople"></span> nya invånare kräver 
         <span data-var='appartments'> lägenheter om antalet boende per lägenhet är </span> 
         <span data-var='peoplePerAppartment' class="TKAdjustableNumber" data-min="2" data-max="10"> personer.</span> (boendetäthet 2014=?) 
         Fördelat på <span data-var='nYears'> år</span> motsvarar det en byggtakt på cirka 
         <span data-var='appartmentsPerYear'></span> lägenheter/år som ska vara inflyttningsklara från och med 
         <span data-var='start'></span>. Under de senaste 10 åren har det i snitt byggstartats nära 1300 bostäder i Malmö. 
         En boendetäthet på <span data-var='peoplePerAppartment'> personer/lägenhet</span> innebär att byggtakten behöver förändras med 
         <span id='plus' class='TKIf' data-var='plus'>+</span><span data-var='appartmentsPerYearChange' id='appartmentsPerYearChange'></span> lägenheter/år. 
         Detta tar dock inte hänsyn till befintlig befolkning och det underskott som redan finns. 
         <!-- Varje hus i diagrammet nedan representerar 1000 lägenheter. --> 
    </p>
    <!-- /Housing -->


    <!-- Preschool -->
    <p id="preschoolWidget" class="widget">
         <span data-var="nPreschoolChildren"></span> nya 1-5åringar motsvarar 
         <span data-var='nPreschools'> förskolor om varje enhet rymmer </span> 
         <span data-var='childrenPerPreschool' class="TKAdjustableNumber" data-min="20" data-max="60"> barn.</span><br>
         <span id="preschoolBar" class="indicatorBar"></span>
    </p>
    <!-- /Preschool -->

    <!-- Primary school -->
    <p id="primaryschoolWidget" class="widget">
         <span data-var="nPrimaryschoolChildren"></span> nya 6-15åringar skapar ett behov av 
         <span data-var='nPrimaryschools'> nya grundskolor om varje enhet rymmer </span>
         <span data-var='childrenPerPrimaryschool' class="TKAdjustableNumber" data-min="300" data-max="1000" data-step="100"> barn.</span>
    </p>
    <!-- /Primary school -->



    <!-- Demography -->
    <div id="demographyWidget" class="widget">
                    <svg id="ageChart"></svg>
                    <span style="left:150px; width:650px; position:absolute;">
                        DEMOGRAPHY WIDGET
                        <span data-var='lol' class="TKAdjustableNumber" data-min="1" data-max="10" data-step="2">lol</span>
                    </span>
                    <br />


    </div>
    <!-- /Demography -->

    <!-- Upper secondary -->
    <p id="uppersecondaryWidget" class="widget">
      Gymnasieskolor
    </p>
    <!-- /Upper secondary -->

    <!-- Care -->
    <p id="careWidget" class="widget">
      Vård och omsorg
    </p>
    <!-- /Care -->

    <!-- Business -->
    <p id="businessWidget" class="widget">
      Näringsliv
    </p>
    <!-- /Business -->

    <!-- Infrastructure -->
    <p id="infrastructureWidget" class="widget">
      Infrastruktur
    </p>
    <!-- /Infrastructure -->

    <!-- Regional -->
    <p id="regionalWidget" class="widget">
      Regionala prognoser
    </p>
    <!-- /Regional -->



</div>


   <div id='controls'>
   
         <h1 style="display:inline; margin-left:50px; font-family: MyriadPro-Bold, Garamond, Arial, Helvetica, sans-serif">Nya malmöbor 2015-2040</h1>
        <p id="">
            Under 
                <span data-var="start" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
                - 
                <span data-var="end" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
                (en 
                <span data-var="nYears"></span>-årsperiod)
                väntas 
                <span id='group'>invånarantalet</span> 
                <span id='increase' class='TKIf' data-var='increase'>öka</span> 
                <span id='decrease' class='TKIf' data-var='decrease'>minska</span> 
                med <span data-var='change'></span> individer i åldrarna 
                <span data-var='minAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span> till 
                <span data-var='maxAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span>. 
        </p>


         <p id="sections" data-var="sectionVisible" class="selector TKSwitchActive">
         <span id="demography" class="selectorItem show"> De demografiska förändringarna </span> påverkar 
                <span id="preschool" class="selectorItem hide"> Förskola </span>
                <span id="primaryschool" class="selectorItem hide"> Grundskola </span>
                <span id="uppersecondary" class="selectorItem hide"> Gymnasieskola </span>
                <span id="housing" class="selectorItem hide"> Bostäder </span>
                <span id="care" class="selectorItem hide"> Vård och omsorg </span>
                <span id="productivity" class="selectorItem hide"> Skattekraft </span>
                <span id="business" class="selectorItem hide"> Näringsliv </span>
                <span id="infrastructure" class="selectorItem hide"> Infrastruktur </span>
                <span id="regional" class="selectorItem hide"> Regionen </span>
         </p>

         
         <p id="ages" data-var="ageVisible" class="selector TKSwitchActive">
                <span id="totalt" class="selectorItem hide"> totalt </span>
                || 
                <span id="totalt" class="selectorItem hide"> 0 </span>
                <span id="totalt" class="selectorItem hide"> 1-5 </span>
                <span id="totalt" class="selectorItem hide"> 6-15 </span>
                <span id="totalt" class="selectorItem hide"> 16-19 </span>
                <span id="totalt" class="selectorItem hide"> 20-64 </span>
                <span id="totalt" class="selectorItem hide"> 65-79 </span>
                <span id="totalt" class="selectorItem hide"> 80+ </span>

         </p>
                    <svg id="yearChart">
                    </svg>

      </div> <!-- tangle end -->


         <div id="widgetContainer">

                    <!-- <svg id="ageChart"></svg> -->

                    <!-- <svg id="svg"></svg> -->
                    
    </div> 
    


<script type='text/javascript'>


var round5 = roundn(5);
var round50 = roundn(50);

var demographyTangle = new Tangle(document.getElementById('demographyWidget'), {
    initialize: function () { console.log('DEMOGRAPHY INITIALIZED...');
        
                              this.start = 2015;
                              this.end = 2040;
                              this.lol = 5;
                            },
    update:     function () {  
       console.log('DEMOGRAPHY UPDATED...');
 }
});



var preschoolTangle = new Tangle(document.getElementById('preschoolWidget'), {
    initialize: function () { console.log('PRESCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPreschoolChildren = 0;
                              this.childrenPerPreschool = 40;
                              this.shareProductivePart = 0;
                            },
    update:     function () { this.perCapita= 1/this.childrenPerPreschool;
                              this.nPreschools = Math.ceil(this.nPreschoolChildren * this.perCapita);
 }
});

var primaryschoolTangle = new Tangle(document.getElementById('primaryschoolWidget'), {
    initialize: function () { console.log('PRIMARY SCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPrimaryschoolChildren = 0;
                              this.childrenPerPrimaryschool = 500;
                              this.shareProductivePart = 0;
                            },
    update:     function () { this.perCapita = 1/this.childrenPerPrimaryschool;
                              this.nPrimaryschools = Math.ceil(this.nPrimaryschoolChildren * this.perCapita);
 }
});



var productivityTangle = new Tangle(document.getElementById('productivityWidget'), {
    initialize: function () { console.log('PRODUCTIVITY INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nProductivePart = 0;
                              this.dependencyRatio = 0;
                              this.shareProductivePart = 0;
                            },
    update:     function () { console.log('PRODUCTIVITY UPDATED...');
 }
});



var housingTangle = new Tangle(document.getElementById('housingWidget'), {
    initialize: function () { this.start = 2015;
                              this.end = 2040;
                              this.nYears = this.end - this.start + 1;
                              this.nPeople = 0;
                              this.appartments = 0;
                              this.peoplePerAppartment = 3;
                              this.appartmentsPerYear = 0;
                              this.appartmentsPerYearChange = 0;
                              this.plus = true;
                              this.appartmentsPerHouse = 1000;
                              this.maxHouses = 150;                 
                            },
    update:     function () { this.nYears = this.end - this.start + 1;
                              this.perCapita = 1/this.peoplePerAppartment;
                              this.appartments = Math.ceil(this.nPeople * this.perCapita);
                              this.appartmentsPerYear = round5(this.appartments/this.nYears);
                              this.appartmentsPerYearChange = this.appartmentsPerYear - 1300;
                              this.plus = this.appartmentsPerYearChange >= 0;
                              document.getElementById('appartmentsPerYearChange').style.color = this.appartmentsPerYearChange >= 0 ? 'red' : 'green'; 

    /*
                              this.nHouses = Math.ceil(this.appartments / this.appartmentsPerHouse);  
                              this.houseData = range(1,this.nHouses);
                              console.log('this.houseData => ' + this.houseData); 
                              update(this.houseData, this.maxHouses);
    */                              

 }
});





                d3.json("data/data.json", function(error, json) {
                    if (error) return console.warn(error);
                    //console.log(json);
                    json.forEach(function(d) {
                        d.age = +d.age;
                    })




var rootElement = document.getElementById('controls');
var model = {
initialize: function() {

                  this.start = 2015;
                  this.end = 2019;
                  this.firstYear = 2015;
                  this.lastYear = 2040;
                  this.nYears = this.end - this.start + 1;
                  this.minAge = 0;
                  this.maxAge = 100;

                    this.data = json;
                    this.changeData = this.data.slice(101, this.data.length);
                    this.xf = crossfilter(this.changeData);
                    this.yearDimension = this.xf.dimension(function(d) { return d.year; });
                    this.ageDimension = this.xf.dimension(function(d) { return d.age; });
                    this.popDimension = this.xf.dimension(function(d) { return d.s; });

                  // this.ageFilters = [[0,101],[0,1],[1,6],[6,16],[16,20],[20,65],[65,80],[80,101]];
                  this.ageVisible = 0;
//-----//
                  this.yearFilter = [this.start, this.end + 1];
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  // this.ageFilter = this.ageFilters[this.ageVisible]);
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });                  
//-----//
                    
                    //this.startData = this.data.slice(0,102);
                    //console.table(this.startData);                  
                    //this.startxf = crossfilter(this.startData);
                    //this.startYearPop = this.startxf.dimension(function(d) { return d.age; });

//-----//

var staticSettings = {
  start: this.firstYear,
  end: this.lastYear,
  barSize: 75,
  width: 800,
  height: 150,
  xLabel: 'År',
  gap: 0.05,
  tickValues: range(2015,2040,5),
  xDomain: range(this.firstYear,this.lastYear),
  yDomain: [0,7000],
  data: this.changeByYear.all()
  };

var dynamicSettings = {
  xmin: this.start,
  xmax: this.end,  
};


this.yearChart = horizontalBarChart('#yearChart', staticSettings, dynamicSettings);
this.yearChart.render();

this.sectionVisible = 0;


this.widgets = ["demographyWidget", "preschoolWidget", "primaryschoolWidget",  
                "uppersecondaryWidget", "housingWidget", "careWidget", "productivityWidget",  
                "businessWidget", "infrastructureWidget", "regionalWidget"];

document.getElementById('widgetContainer').appendChild(document.getElementById(this.widgets[this.sectionVisible]));

//-----//


var ss = {
  start: 0,
  end: 100,
  barSize: 75,
  width: 150,
  height: 600,
  xLabel: 'Ålder',
  gap: 0.15,
  tickValues: range(0,100,5),
  xDomain: range(0,100),
  yDomain: [0,2500],
  data: this.changeByAge.all()
  };

var ds = {
  xmin: this.minAge,
  xmax: this.maxAge,  
};


this.ageChart = verticalBarChart('#ageChart', ss, ds);
this.ageChart.render();


//-----//

this.sectionVisible = 0;
// this.ageVisible = 0;

//-----//

                 
                 
            },
update: function() {

                  this.start = this.end - this.start >= 0 ? this.start : this.end;
                  this.end = this.end - this.start >= 0 ? this.end : this.start;

                  this.minAge = this.maxAge - this.minAge >= 0 ? this.minAge : this.maxAge;
                  this.maxAge = this.maxAge - this.minAge >= 0 ? this.maxAge : this.minAge;
                  this.nYears = this.end - this.start + 1;
                  this.yearFilter = [this.start, this.end + 1];
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  
                  //---//
                  
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                    // förändringsdata börjar vid 2015
                  
                  
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });

                  this.change = round5(this.xf.groupAll()
                                            .reduceSum(function(d) { return d.s; })
                                            .value());

                  this.increase = this.change >= 0;
                  this.decrease = !this.increase;
                  
//-----//

   for (var i = 0, len = this.widgets.length; i < len; i++) {
            document.getElementById('inactive').appendChild(document.getElementById(this.widgets[i]));
   }

   document.getElementById('widgetContainer').appendChild(document.getElementById(this.widgets[this.sectionVisible]));

//-----//


               var allAges = this.changeByAge.all();

                  this.n0 = sumInterval(allAges, 0, 0);
                  this.n1_5 = sumInterval(allAges, 1, 5);
                  this.n6_15 = sumInterval(allAges, 6, 15);
                  this.n16_19 = sumInterval(allAges, 16, 19);
                  this.n20_64 = sumInterval(allAges, 20, 64);
                  this.n65_79 = sumInterval(allAges, 65, 79);
                  this.n80_100 = sumInterval(allAges, 80, 100);
                  this.nAll = sumInterval(allAges, 0, 100);

                //   console.log('this.n0 => ' + this.n0);
                //   console.log('this.n1_5 => ' + this.n1_5);
                //   console.log('this.n6_15 => ' + this.n6_15);
                //   console.log('this.n16_19 => ' + this.n16_19);                  
                //   console.log('this.n20_64 => ' + this.n20_64);
                //   console.log('this.n65_79 => ' + this.n65_79);                                               
                //   console.log('this.n80_100 => ' + this.n80_100);
                //   console.log('this.nAll => ' + this.nAll);
                // console.log('sum of all ages => ' + this.nAll);

//-----//

// PRODUCTIVITY
// antal i yrkesverksam ålder 2014: 198463
// räknar bara på förändringen
this.nProductivePart = this.n20_64;
this.dependencyRatio = Math.round((this.nAll / this.nProductivePart)*100)/100;
this.shareProductivePart = 100 * 1/this.dependencyRatio;
productivityTangle.setValues({  start: this.start, end: this.end,
                                nProductivePart: this.nProductivePart,
                                dependencyRatio: this.dependencyRatio,
                                shareProductivePart: this.shareProductivePart                                
        });

// HOUSING
housingTangle.setValues({ start: this.start, end: this.end, 
                          nPeople: round50(this.nAll)
});

// PRESCHOOL
preschoolTangle.setValues({ start: this.start, end: this.end, 
                            nPreschoolChildren: round50(this.n1_5)
});


// PRIMARY SCHOOL
primaryschoolTangle.setValues({ start: this.start, end: this.end, 
                                nPrimaryschoolChildren: round50(this.n6_15)
});


//------//

this.yearChart.update({ xmin: this.start, xmax: this.end });

this.ageChart.update({ xmin: this.minAge, xmax: this.maxAge });


//-----//


        }
    }
    
    var mainTangle = new Tangle(rootElement, model);



//-----//


        var brushScaleX = d3.scale.linear()
                                .domain([2015, 2040])
                                .range([0,800]);

        var ordinalX = d3.scale.ordinal()
                                .domain(range(2015,2040))
                                .range([0,800]);                                
                                
        var brush = d3.svg.brush()
            .x(brushScaleX)
            .extent([2015, 2019])
            .on("brush", function() { 

                console.log('brushed... extent => ' + brush.extent().map(function(n) { return Math.round(n); }));
                var extent0 = brush.extent();

                mainTangle.setValue('start', Math.round(extent0[0]));
                mainTangle.setValue('end', Math.round(extent0[1]));
                
            });                
        
        console.log('brush extent >> ' + brush.extent());
                
        var gBrush = d3.select('#yearChart')
                        .append('g')
                        .attr('id', 'gBrush')
                        .attr('class', 'brush')
                        .call(brush);

        d3.select('#yearChart')
            .on('mouseover', function() {
                    gBrush.selectAll('.extent').attr('height', 80).style('visibility', 'visible');
                    gBrush.selectAll('.resize').selectAll('rect')
                                        .attr({'width': 5, 'height': 80})
                                        .style({'visibility': 'visible', 'fill': 'purple', 'fill-opacity': '0.3'});
            })
            .on('mouseout', function() {

                    gBrush.selectAll('.extent').attr('height', 80).style('visibility', 'hidden');
                    gBrush.selectAll('.resize').selectAll('rect')
                                        .attr({'width': 5, 'height': 80})
                                        .style({'visibility': 'hidden', 'fill': 'purple', 'fill-opacity': '0.3'});
            });
        

//-----//


/*

wc = document.getElementById('widgetContainer');
pw = document.getElementById('productivityWidget');
wc.appendChild(pw);
// document.getElementById('widgetContainer').children;
// document.getElementById('inactive').appendChild(document.getElementById('preschoolWidget'));
*/


                    return json;
                })   // end of d3.json

//-------//





</script>






</body>
</html>
 
