<!DOCTYPE html>
<html>

   <head>
   <meta charset="UTF-8">



<script src='Tangle-0.1.0/Tangle.js' type='text/javascript'></script>
<link rel="stylesheet" href='Tangle-0.1.0/TangleKit/TangleKit.css' type='text/css'></style>
<script src='Tangle-0.1.0/TangleKit/mootools.js' type='text/javascript'></script>
<script src='Tangle-0.1.0/TangleKit/sprintf.js' type='text/javascript'></script>
<script src='Tangle-0.1.0/TangleKit/BVTouchable.js' type='text/javascript'></script>
<script src='Tangle-0.1.0/TangleKit/TangleKit.js' type='text/javascript'></script>
<script src='d3/d3.min.js'></script>
<script src='crossfilter.min.js'></script>
<!-- <script src='dc.js-2.0.0-beta.19/dc.min.js'></script> -->



<style type='text/css'>


#controls {text-align: left; 
margin-left:325px;
margin-top:20px;
margin-bottom:-20px;
font-size: 30px;
}


#controls {
    position: absolute;
    width: 950px;
    font-size: 24px;
}

#timelineContainer {
    position: absolute;
    width: 800px;
    height: 100px;
    left: 300px;
}

#yearChartContainer {
    position: absolute;
    width: 800px;
    height: 150px;    
    left: 150px;
}

#chartContainer {
    position: absolute;
    width: 800px;
    height: 150px;    
    left: 150px;
    top: 500px;
}

#timeline {
    position: absolute;
    width: 0px;
    height: 20px;
    border: none;
/*    border-radius: 15px; */
    background-color: lightgreen;
}

#yearChart {
    position: absolute;
    top: 400px;
    height: 150px;
    width: 800px;
    left: 150px;    
}

#svg {
    display: inline;
    position: absolute;
    width: 800px;
    height: 600px;  
    left: 150px;
    top: 500px;
    background-color: white;
    
//    background-image: url(bg.png);
    background-position: left top;
    background-size: 800px 560px;
    background-repeat: no-repeat;    
}

#ageChart {
    position: absolute;
    height: 600px;
    width:150px;  
    left: 0px;
    top: 500px;
    background-color: white;

}


.widget {
    position: relative;
    width: 800px;
    left: 300px;
}


.widget:hover {
    background-color: #e0e0e0;
}

indicatorBar {
    background-color: #b5b5b5;
}

#increase {
    color: green;
}

#decrease {
    color: red;
}

.TKAdjustableNumber {
    color: #00b5e2;
    font-weight: bold;
}

.TKAdjustableNumberHelp {
    color: #00b5e2;
    font-size: 18px;
}

.hide {
    text-decoration: line-through;
    color: #b5b5b5;
}

.show {
    color: #00b5e2;
    font-weight: bold;    
}

.xAxis path {
    fill: none;
    stroke: none;
}


.xAxis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.xAxis text {
    font-family: sans-serif;
    font-size: 11px;
}



.brush .extent {
  stroke: #000;
  fill-opacity: .125;
  fill: #b5b5b5;
  shape-rendering: crispEdges;
}



</style>








<script type='text/javascript'>






var outerWidth = 500,
    outerHeight = 400,
    margin = {top: 30, right: 30, bottom: 50, left: 50},
    width = outerWidth - margin.left - margin.right,
    height = outerHeight - margin.top - margin.bottom;


/*
var init = function(start, end, nYears, change, peoplePerHouse, nHouses, maxHouses){

console.log("init...");

}
*/



var update = function(houseData, maxHouses){



var svgHeight = 500;


var housePoints = [[100,50], [100,150], [80,150], [150,200],
                  [220,150], [200,150], [200,50], [100,50]];

console.log('number of houses => ' + houseData.length);

var transitionTime = 30;

var houseScaleX = d3.scale.linear().domain([1,maxHouses]).range([0,500]);  //---//
//d3.select('#svg').selectAll('polygon').remove();

var house = d3.select('#svg').selectAll('polygon')
                            .data(houseData, function(d,i) { return d; });
                            
                        house
                            .enter()
                            .append("polygon")
                            .attr("points", housePoints.map(function(d) { 
                                    var x = d[0],
                                    y = svgHeight - d[1] + 100;
                                    return [x,y]; }))                                  
                            .attr("stroke", "black")
                            .attr("stroke-width", 1)
                            .attr("fill", "#00b5e2")
                            .attr("transform", function(d,i) { return "translate(" + (houseScaleX(d)) + ")"; })
                            .attr('n', function(d,i) { return i; })
                            .style('fill', 'Bisque');                               
                             
                            
                        house.exit()
                            .transition().duration(transitionTime * 5)
                            .style('fill', 'orange')
                            .style('fill-opacity', 0)
                            .style('stroke-opacity', 0)
                            .remove();

   }





</script>

   </head>
  <!-- <body onload="setUpTangle()"> -->
  <body>





    <!-- Productivity -->
    <p id="productivity" class="widget">
         <span data-var="nProductivePart"></span> fler i åldrarna 20-64 innebär att 
         <span data-var="shareProductivePart" data-format="%.1f">%</span> av de nya malmöborna 
         <span data-var='start'></span> - <span data-var='end'></span> är i yrkesverksam ålder. 
         Om vi räknar på de nya malmöborna utan att ta hänsyn till befintlig befolkning så är försörjningskvoten 
         <span data-var="dependencyRatio"></span>. Detta är det antal personer varje 
        individ i yrkesverksam ålder måste försörja, inklusive sig själv. Att en relativt stor del 
        av tillväxten sker i de icke yrkesverksamma åldrarna innebär att dagens försörjningskvot 
        (1,60) väntas öka till 1,66 år 2025 och ... år 2040. Det ställer stora krav på sysselsättningen. 
    </p>
    <!-- /Productivity -->


    <!-- Housing -->
    <p id="housing" class="widget">
         <span data-var="nPeople"></span> nya invånare kräver 
         <span data-var='appartments'> lägenheter om antalet boende per lägenhet är </span> 
         <span data-var='peoplePerAppartment' class="TKAdjustableNumber" data-min="2" data-max="10"> personer.</span> (boendetäthet 2014=?) 
         Fördelat på <span data-var='nYears'> år</span> motsvarar det en byggtakt på cirka 
         <span data-var='appartmentsPerYear'></span> lägenheter/år som ska vara inflyttningsklara från och med 
         <span data-var='start'></span>. Under de senaste 10 åren har det i snitt byggstartats nära 1300 bostäder i Malmö. 
         En boendetäthet på <span data-var='peoplePerAppartment'> personer/lägenhet</span> innebär att byggtakten behöver förändras med 
         <span id='plus' class='TKIf' data-var='plus'>+</span><span data-var='appartmentsPerYearChange' id='appartmentsPerYearChange'></span> lägenheter/år. 
         Varje hus i diagrammet nedan representerar 1000 lägenheter. 
    </p>
    <!-- /Housing -->


    <!-- Preschool -->
    <p id="preschool" class="widget">
         <span data-var="nPreschoolChildren"></span> nya 1-5åringar motsvarar 
         <span data-var='nPreschools'> förskolor om varje enhet rymmer </span> 
         <span data-var='childrenPerPreschool' class="TKAdjustableNumber" data-min="20" data-max="60"> barn.</span><br>
         <span id="preschoolBar" class="indicatorBar"></span>
    </p>
    <!-- /Preschool -->

    <!-- Primary school -->
    <p id="primaryschool" class="widget">
         <span data-var="nPrimaryschoolChildren"></span> nya 6-15åringar skapar ett behov av 
         <span data-var='nPrimaryschools'> nya grundskolor om varje enhet rymmer </span>
         <span data-var='childrenPerPrimaryschool' class="TKAdjustableNumber" data-min="3" data-max="10">00 barn.</span>
    </p>
    <!-- /Primary school -->



<script type='text/javascript'>
/*
var range = function(n) { return Array.apply(null, Array(n)).map(function (_, i) {return i+1;}); };
console.log('range 1-5 => ' + range(5));
*/

var range = function(from,to,step) { 
                        step = step || 1;
                        from = from || 0;                        
                        to = to || 1;
                        
                        var len = to - from + 1;
                        
                        return Array.apply(null, Array(len)).map(function (_, i) {return from+i;})
                                    .filter(function(n,i) { return ((n - from) % step) == 0; } ); 
                                    };
                                    
console.log('range 0-100 step 5 => ' + range(0,100,5));


var roundn = function(n) {
    return function(m) {
        return(Math.round(m/n)*n);
    }
}

var round5 = roundn(5);
var round50 = roundn(50);



var preschoolTangle = new Tangle(document.getElementById('preschool'), {
    initialize: function () { console.log('PRESCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPreschoolChildren = 0;
                              this.childrenPerPreschool = 40;
                              this.shareProductivePart = 0;
                            },
    update:     function () { this.perCapita= 1/this.childrenPerPreschool;
                              this.nPreschools = Math.ceil(this.nPreschoolChildren * this.perCapita);
 }
});

var primaryschoolTangle = new Tangle(document.getElementById('primaryschool'), {
    initialize: function () { console.log('PRIMARY SCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPrimaryschoolChildren = 0;
                              this.childrenPerPrimaryschool = 5;
                              this.shareProductivePart = 0;
                            },
    update:     function () { this.perCapita = 1/this.childrenPerPrimaryschool;
                              this.nPrimaryschools = Math.ceil(this.nPrimaryschoolChildren * this.perCapita);
 }
});



var productivityTangle = new Tangle(document.getElementById('productivity'), {
    initialize: function () { console.log('PRODUCTIVITY INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nProductivePart = 0;
                              this.dependencyRatio = 0;
                              this.shareProductivePart = 0;
                            },
    update:     function () { console.log('PRODUCTIVITY UPDATED...');
 }
});



var housingTangle = new Tangle(document.getElementById('housing'), {
    initialize: function () { this.start = 2015;
                              this.end = 2040;
                              this.nYears = this.end - this.start + 1;
                              this.nPeople = 0;
                              this.appartments = 0;
                              this.peoplePerAppartment = 3;
                              this.appartmentsPerYear = 0;
                              this.appartmentsPerYearChange = 0;
                              this.plus = true;
                              this.appartmentsPerHouse = 1000;
                              this.maxHouses = 150;                 
                            },
    update:     function () { this.nYears = this.end - this.start + 1;
                              this.perCapita = 1/this.peoplePerAppartment;
                              this.appartments = Math.ceil(this.nPeople * this.perCapita);
                              this.appartmentsPerYear = round5(this.appartments/this.nYears);
                              this.appartmentsPerYearChange = this.appartmentsPerYear - 1300;
                              this.plus = this.appartmentsPerYearChange >= 0;
                              document.getElementById('appartmentsPerYearChange').style.color = this.appartmentsPerYearChange >= 0 ? 'red' : 'green'; 

                              this.nHouses = Math.ceil(this.appartments / this.appartmentsPerHouse);  
                              this.houseData = range(1,this.nHouses);
    console.log('this.houseData => ' + this.houseData); 
                              update(this.houseData, this.maxHouses);

 }
});




var cumsum = function(arr) { return (arr.map(function(n,i) { return arr.slice(0,i+1).reduce(function(x,y) { return x + y; }); })); }









var makeAgeGroup = function(min,max,thing,perCapita) { return { min: min,
                                                                max: max,
                                                                n: 0,
                                                                thing: thing,
                                                                shapePoints: [],
                                                                perCapita: perCapita
                                                            };
                                                    }



                d3.json("data/data.json", function(error, json) {
                    if (error) return console.warn(error);
                    //console.log(json);
                    json.forEach(function(d) {
                        d.age = +d.age;
                    })

/*
function setUpTangle() { 
*/

var rootElement = document.getElementById('controls');
var model = {
initialize: function() {

                  this.start = 2015;
                  this.end = 2025;
                  this.firstYear = 2015;
                  this.lastYear = 2040;
                  this.nYears = this.end - this.start + 1;
                  this.minAge = 0;
                  this.maxAge = 100;

                    this.data = json;
                    //this.startData = this.data.slice(0,102);
                    this.changeData = this.data.slice(101, this.data.length);
                    this.xf = crossfilter(this.changeData);
                    this.yearDimension = this.xf.dimension(function(d) { return d.year; });
                    this.ageDimension = this.xf.dimension(function(d) { return d.age; });
                    this.popDimension = this.xf.dimension(function(d) { return d.s; });


                    console.table(this.startData);
                                        
                    //this.startxf = crossfilter(this.startData);
                    //this.startYearPop = this.startxf.dimension(function(d) { return d.age; });
                    
                    this.changeByYear = [];
                    this.yearData = [];


                 //init(this.start, this.end, this.nYears, 150000, this.peoplePerHouse * 100, this.nHouses, this.maxHouses);



/*
//d3.select('#timelineContainer')
d3.select('#yearChartContainer')
    //.append('div').attr('id', 'yearChartContainer')
    .append('svg').attr('id', 'yearChart');
    */
// append bar chart

                  this.yearFilter = [this.start, this.end + 1];
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });                  
//-----//

this.width = 800;
this.height = 100;
this.barSize = 75;

var that = this;

// YEAR CHART

var yearScale = d3.scale.ordinal()
                .domain(this.changeByYear.all().map(function(d) { return d.key; }))
                .rangeRoundBands([0,800], 0.05);                
var yScaleYear = d3.scale.linear()
                .domain([0,2500])
                .range([0,this.barSize]);

this.yearSvg = d3.select('#yearChart');

this.yearBars = this.yearSvg
                .selectAll('rect')           
                .data(this.changeByYear.all(), function(d) { return d.key; });

console.log('min, max => ' + d3.min(that.changeByYear.all(), function(d) { return d.value; }) + ', ' +
                             d3.max(that.changeByYear.all(), function(d) { return d.value; }));


                this.yearBars
                    .enter()
                    .append('rect')
                    .attr({ width: this.width / 26,
                        height: function(d) { return yScaleYear(d.value); },
                        x: function(d) { return yearScale(d.key); },
                        y: function(d) { return 75 - yScaleYear(d.value); },   //-----//
                        year: function(d) { return d.key; },
                        value: function(d) { return d.value; }                   
                    })
                    .style('fill', 'grey');

        this.xAxisYear = d3.svg.axis()
                    .scale(yearScale)
                    .orient('bottom')
                    .tickValues(range(2015,2040,5));
                    //.tickValues([2015,2020,2025,2030,2035,2040]);
        this.yearSvg.append('g')
                    .attr('class', 'xAxis')
                    .attr('transform', 'translate(0,' + (this.barSize + 5) + ')')
                    .call(this.xAxisYear);
                    
this.yearSvg.append('text')
            .text("År")
            .style('font-size', 18)
            .attr({ x: 0, y: 20 });    


//-----//



//-----//

// AGE CHART



var ageScale = d3.scale.ordinal()
                .domain(this.changeByAge.all().map(function(d) { return d.key; }))
                .rangeRoundBands([600,0], 0.15);                
var yScaleAge = d3.scale.linear()
                .domain([0,2500])
                .range([0,this.barSize]);

this.ageSvg = d3.select('#ageChart');

this.ageBars = this.ageSvg
                .selectAll('rect')           
                .data(this.changeByAge.all(), function(d) { return d.key; });

console.log('min, max => ' + d3.min(that.changeByAge.all(), function(d) { return d.value; }) + ', ' +
                             d3.max(that.changeByAge.all(), function(d) { return d.value; }));


                this.ageBars
                    .enter()
                    .append('rect')
                    .attr({ height: ageScale.rangeBand(),
                        width: function(d) { return Math.abs(yScaleAge(d.value)); },                        
                        y: function(d) { return ageScale(d.key); },
                        x: function(d) { return yScaleAge(d.value) >= 0 ? 75 - yScaleAge(d.value) : 75; },   //-----//
                        age: function(d) { return d.key; },
                        value: function(d) { return d.value; }                   
                    })
                    .style('fill', 'blue');

        this.xAxisAge = d3.svg.axis()
                    .scale(ageScale)
                    .orient('right')
                    .tickValues(range(0,100,5));
                    //.tickValues([0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100]);
        this.ageSvg.append('g')
                    .attr('class', 'xAxis')
                    .attr('transform', 'translate(' + (this.barSize + 5) + ',0)')
                    .call(this.xAxisAge);

this.ageSvg.append('text')
            .text("Ålder")
            .style('font-size', 18)
            .attr({ x: 10, y: 20 });                    

var minAgeScaled = ageScale(this.minAge) + ageScale.rangeBand();
var maxAgeScaled = ageScale(this.maxAge);


this.ageIndicatorMin = this.ageSvg.append('line')
                        .attr({ x1: 0, x2: 75, y1: minAgeScaled, y2: minAgeScaled,
                                "stroke-width": 1, stroke: 'black' });

this.ageIndicatorMax = this.ageSvg.append('line')
                        .attr({ x1: 0, x2: 75, y1: maxAgeScaled, y2: maxAgeScaled,
                                "stroke-width": 1, stroke: 'black' });



//-----//


this.nPreschoolChildren = 0;
this.preschool = 0;
this.childrenPerPreschool = 30;
this.nPrimaryschoolChildren = 0;
this.primaryschool = 0;
this.childrenPerPrimaryschool = 5;



this.n0 = makeAgeGroup(0,0,"någonting",1/10);
this.n1_5 = makeAgeGroup(1,5,"förskolor",1/this.childrenPerPreschool);
this.n6_15 = makeAgeGroup(6,15,"grundskolor",1/(this.childrenPerPrimaryschool * 100));
this.n16_19 = makeAgeGroup(16,19,"gymnasieskolor",1/500);
this.n20_64 = makeAgeGroup(20,64,"restauranger",1/2000);
this.n65_79 = makeAgeGroup(65,79,"golfbanor",1/1000);
this.n80_100 = makeAgeGroup(80,100,"anpassade boenden",1/200);
this.allAges = makeAgeGroup(0,100,"lägenheter",1/this.peoplePerAppartment);

this.show0 = false;
this.show1_5 = true;
this.show6_15 = true;
this.show16_19 = false;
this.show20_64 = false;
this.show65_79 = false;
this.show80_100 = false;



this.showTotal = true;

//-----//




                 
                 
            },
update: function() {

                  /*
                  this.start = this.end - this.start >= 1 ? this.start : this.end - 1;
                  this.end = this.end - this.start >= 1 ? this.end : this.start + 1; 
                  */

                  this.start = this.end - this.start >= 0 ? this.start : this.end;
                  this.end = this.end - this.start >= 0 ? this.end : this.start;

                  /*
                  this.minAge = this.maxAge - this.minAge >= 1 ? this.minAge : this.maxAge - 1;
                  this.maxAge = this.maxAge - this.minAge >= 1 ? this.maxAge : this.minAge + 1;
                  */

                  this.minAge = this.maxAge - this.minAge >= 0 ? this.minAge : this.maxAge;
                  this.maxAge = this.maxAge - this.minAge >= 0 ? this.maxAge : this.minAge;
                  this.nYears = this.end - this.start + 1;
                  this.yearFilter = [this.start, this.end + 1];
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  
                  //---//
                  
                  console.log('this.showTotal --> ' + this.showTotal);
                                   
                  //---//
                  
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                    // förändringsdata börjar vid 2015
                  
                  
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });


                //console.table(this.changeByAge.all());
                //console.table(this.changeByYear.all());
                //console.log("total befolkningstillväxt >> " + this.yearDimension.groupAll()
                //            .reduceSum(function(d) { return d.s; }).value());
                
                           
                    //this.popByYear = this.changeByYear.all();
                    //this.startYearPop = this.popByYear[this.start - this.firstYear];         
                    //this.endYearPop = cumsum2(this.popByYear.slice(this.start - this.firstYear, this.end - this.firstYear + 1), "s");

                  this.change = round5(this.xf.groupAll()
                                            .reduceSum(function(d) { return d.s; })
                                            .value());

                    console.log('total folkökning: ' + this.change);

                  this.increase = this.change >= 0;
                  this.decrease = !this.increase;
                  


//-----//

    // ÅLDERSGRUPPER
                  this.n0.n = this.changeByAge.all().slice(0,1)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n0.n => ' + this.n0.n);

                  this.n1_5.n = this.changeByAge.all().slice(1,6)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n1_5.n => ' + this.n1_5.n);
                    
                  this.n6_15.n = this.changeByAge.all().slice(6,16)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n6_15.n => ' + this.n6_15.n);
                  
                  this.n16_19.n = this.changeByAge.all().slice(16,20)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n16_19.n => ' + this.n16_19.n);                  
                  
                  this.n20_64.n = this.changeByAge.all().slice(20,65)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n20_64.n => ' + this.n20_64.n);
                  
                  this.n65_79.n = this.changeByAge.all().slice(65,80)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n65_79.n => ' + this.n65_79.n);                                               

                  this.n80_100.n = this.changeByAge.all().slice(80,101)
                    .map(function(d) { return d.value; })
                    .reduce(function(a,b) { return a + b; });
                  console.log('this.n80_100.n => ' + this.n80_100.n);

/*
                this.ageData = [this.n0, this.n1_5, this.n6_15, this.n16_19, this.n20_64, this.n65_79, this.n80_100]
                                    .map(function(ageGroup) {
                                        return { min: ageGroup.min, max: ageGroup.max, n: ageGroup.n, 
                                                 key: (ageGroup.min == ageGroup.max) ? ageGroup.min.toString() : ageGroup.min.toString() + '-' + ageGroup.max.toString() };
                                    });
*/
                                    
                //console.table(this.ageData);

                this.allAges.n = [this.n0.n, this.n1_5.n, this.n6_15.n, this.n16_19.n, this.n20_64.n, this.n65_79.n, this.n80_100.n]
                                    .reduce(function(a,b) { return a + b; });
                console.log('sum of all ages => ' + this.allAges.n);


// PRODUCTIVITY
// antal i yrkesverksam ålder 2014: 198463
// räknar bara på förändringen

this.nProductivePart = this.n20_64.n;
this.dependencyRatio = Math.round((this.allAges.n / this.nProductivePart)*100)/100;
this.shareProductivePart = 100 * 1/this.dependencyRatio;

productivityTangle.setValues({  start: this.start, end: this.end,
                                nProductivePart: this.nProductivePart,
                                dependencyRatio: this.dependencyRatio,
                                shareProductivePart: this.shareProductivePart                                
        });



// HOUSING

/*
this.nPeople = round50(this.allAges.n);
this.allAges.perCapita = 1/this.peoplePerAppartment;
this.appartments = Math.ceil(this.allAges.n * this.allAges.perCapita);
this.appartmentsPerYear = round5(this.appartments/this.nYears);
this.appartmentsPerYearChange = this.appartmentsPerYear - 1300;
*/

housingTangle.setValues({ start: this.start, end: this.end, 
                          nPeople: round50(this.allAges.n)
});




//-----//

// PRESCHOOL

/*
this.nPreschoolChildren = round50(this.n1_5.n);
this.n1_5.perCapita = 1/this.childrenPerPreschool;
this.preschool = Math.ceil(this.n1_5.n * this.n1_5.perCapita);


console.log('Med ' + this.n1_5.n + ' nya barn och ' + Math.round(1/this.n1_5.perCapita) + ' barn per förskola behöver vi bygga ' + Math.ceil(this.n1_5.n * this.n1_5.perCapita) + ' ' + this.n1_5.thing 
            + ' vilket motsvarar ' + Math.ceil((this.n1_5.n * this.n1_5.perCapita)/this.nYears) + ' förskolor per år. ');
*/

preschoolTangle.setValues({ start: this.start, end: this.end, 
                            nPreschoolChildren: round50(this.n1_5.n)
});


// PRIMARY SCHOOL
/*
this.nPrimaryschoolChildren = round50(this.n6_15.n);
this.n6_15.perCapita = 1/(this.childrenPerPrimaryschool * 100);
this.primaryschool = Math.ceil(this.n6_15.n * this.n6_15.perCapita);
*/


primaryschoolTangle.setValues({ start: this.start, end: this.end, 
                                nPrimaryschoolChildren: round50(this.n6_15.n)
});


/*
this.nPreschoolChildren * this.childrenPerPreschool
this.nPrimaryschoolChildren * this.childrenPerPrimaryschool
*/


//------//


/*
    this.nHouses = Math.ceil(this.appartments / this.appartmentsPerHouse);  

    this.houseData = range(0,this.nHouses);
    //console.log('this.houseData => ' + this.houseData); 

    update(this.houseData, this.maxHouses);
*/    
    

//------//



this.width = 800;
this.barSize = 75;

var that = this;

var yDomainYear = [0, d3.max(that.changeByYear.all(), function(d) { return d.value; })];
                  //d3.min(that.changeByYear.all(), function(d) { return d.value; }),

console.log('min, max => ' + yDomainYear); 

var yearScale = d3.scale.ordinal()
                .domain(this.changeByYear.all().map(function(d) { return d.key; }))
                .rangeRoundBands([0,800], 0.05);                      
var yScaleYear = d3.scale.linear()
                .domain([0,7000])
                //.domain(yDomainYear)
                .range([0,this.barSize]);
                

                
                this.yearBars
                    .attr({ width: yearScale.rangeBand(),
                        height: function(d) { return yScaleYear(d.value) >= 0 ? yScaleYear(d.value) : 0; },
                        x: function(d) { return yearScale(d.key); },
                        y: function(d) { return 75 - yScaleYear(d.value); },   //-----//
                        year: function(d) { return d.key; },
                        value: function(d) { return d.value; }                   
                    })
                    .style('fill', function(d) {
                        console.log('this.start, this.end => ' + that.start + ', ' + that.end);                  
                        return ((d.key >= that.start) && (d.key <= that.end)) ? '#00b5e2' : '#b5b5b5';                    
                    });                    
                    
                    //.style('fill', 'blue');
                
                this.yearBars.exit().remove();
                


//-----//


var ageScale = d3.scale.ordinal()
                .domain(this.changeByAge.all().map(function(d) { return d.key; }))
                .rangeRoundBands([600,0], 0.15);                
var yScaleAge = d3.scale.linear()
                .domain([0,2500])
                .range([0,this.barSize]);


                this.ageBars
                    .attr({ height: ageScale.rangeBand(),
                        width: function(d) { return Math.abs(yScaleAge(d.value)); },                        
                        y: function(d) { return ageScale(d.key); },
                        x: function(d) { return yScaleAge(d.value) >= 0 ? 75 - yScaleAge(d.value) : 75; },   //-----//
                        age: function(d) { return d.key; },
                        value: function(d) { return d.value; }                   
                    })
                    .style('fill', function(d) {
                        console.log('this.minAge, this.maxAge => ' + that.minAge + ', ' + that.maxAge);                  
                        return ((d.key >= that.minAge) && (d.key <= that.maxAge)) ? '#00b5e2' : '#b5b5b5';                    
                    });  
                    
                this.ageBars.exit().remove();


var minAgeScaled = ageScale(this.minAge) + ageScale.rangeBand();
var maxAgeScaled = ageScale(this.maxAge);


        this.ageIndicatorMin
            .attr({ y1: minAgeScaled, y2: minAgeScaled });

        this.ageIndicatorMax
            .attr({ y1: maxAgeScaled, y2: maxAgeScaled });




//-----//



        }
    }
    
    var mainTangle = new Tangle(rootElement, model);



/*
}

setUpTangle();
*/


                    return json;
                })   // end of d3.json


//-------//





</script>




   <div id='controls'>
   
         <h1 style="display:inline; margin-left:50px; font-family: MyriadPro-Bold, Garamond, Arial, Helvetica, sans-serif">Nya malmöbor 2015-2040</h1>
    <p>
        
          Under 
           <span data-var="start" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
            - 
           <span data-var="end" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
            (en 
           <span data-var="nYears"></span>-årsperiod)
           väntas 
           <span id='group'>invånarantalet</span> 
         <span id='increase' class='TKIf' data-var='increase'>öka</span> 
         <span id='decrease' class='TKIf' data-var='decrease'>minska</span> 
         med 
         <span data-var='change'></span> individer <br>i åldrarna 
         <span data-var='minAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span> till 
         <span data-var='maxAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span>. 
         
    </p>

<!--
    <p>
         <span data-var="nPeople"></span> nya invånare kräver 
         <span data-var='appartments'> lägenheter om antalet boende per lägenhet är </span> 
         <span data-var='peoplePerAppartment' class="TKAdjustableNumber" data-min="2" data-max="10"> personer.</span> (boendetäthet 2014=?) 
         Fördelat på <span data-var='nYears'> år</span> motsvarar det en byggtakt på cirka 
         <span data-var='appartmentsPerYear'></span> lägenheter/år som ska vara inflyttningsklara från och med 
         <span data-var='start'></span>. Under de senaste 10 åren har det i snitt byggstartats nära 1300 bostäder i Malmö. 
         En boendetäthet på <span data-var='peoplePerAppartment'> personer/lägenhet</span> innebär då att den årliga byggtakten behöver förändras med 
         <span data-var='appartmentsPerYearChange'></span> lägenheter. 
         Varje hus i diagrammet nedan representerar 1000 lägenheter. 
    </p>
         
    <p>
         <span data-var="nPreschoolChildren"></span> nya 1-5åringar motsvarar 
         <span data-var='preschool'> förskolor om varje enhet rymmer </span> 
         <span data-var='childrenPerPreschool' class="TKAdjustableNumber" data-min="20" data-max="60"> barn.</span><br>
         <span id="preschoolBar" class="indicatorBar"></span>

         <span data-var="nPrimaryschoolChildren"></span> nya 6-15åringar skapar ett behov av 
         <span data-var='primaryschool'> nya grundskolor om varje enhet rymmer </span>
         <span data-var='childrenPerPrimaryschool' class="TKAdjustableNumber" data-min="3" data-max="10">00 barn.</span>
    </p>

-->

<!--      
    <p>
         <span data-var="nProductivePart"></span> fler i åldrarna 20-64 innebär att 
         <span data-var="shareProductivePart" data-format="%.1f">%</span> av de nya malmöborna 
         <span data-var='start'></span> - <span data-var='end'></span> är i yrkesverksam ålder. 
         Om vi räknar på de nya malmöborna utan att ta hänsyn till befintlig befolkning så är försörjningskvoten 
         <span data-var="dependencyRatio"></span>. Detta är det antal personer varje 
        individ i yrkesverksam ålder måste försörja, inklusive sig själv. Att en relativt stor del 
        av tillväxten sker i de icke yrkesverksamma åldrarna innebär att dagens försörjningskvot 
        (1,60) väntas öka till 1,66 år 2025 och ... år 2040. Det ställer stora krav på sysselsättningen. 
    </p>         
-->
         
         Nedan visas tänkbara konsekvenser av befolkningstillväxten 
         <span data-var="showTotal" class="TKToggle TKSwitch">
            <span class="hide">totalt</span> 
            <span class="show">totalt</span>          
         </span> samt i planeringsåldrarna <br>

         <span data-var="show0" class="TKToggle TKSwitch">
            <span class="hide"> 0 </span> 
            <span class="show"> 0 </span>          
         </span>,   
         <span data-var="show1_5" class="TKToggle TKSwitch">
            <span class="hide">1-5</span> 
            <span class="show">1-5</span>          
         </span>,                 
         <span data-var="show6_15" class="TKToggle TKSwitch">
            <span class="hide">6-15</span> 
            <span class="show">6-15</span>          
         </span>,  
         <span data-var="show16_19" class="TKToggle TKSwitch">
            <span class="hide">16-19</span> 
            <span class="show">16-19</span>          
         </span>,           
         <span data-var="show20_64" class="TKToggle TKSwitch">
            <span class="hide">20-64</span> 
            <span class="show">20-64</span>          
         </span>,           
         <span data-var="show65_79" class="TKToggle TKSwitch">
            <span class="hide">65-79</span> 
            <span class="show">65-79</span>          
         </span> och 
         <span data-var="show80_100" class="TKToggle TKSwitch">
            <span class="hide">80+</span> 
            <span class="show">80+</span>          
         </span>.<br>
         
                  
         <div id="result">

                    <svg id="ageChart"></svg>
                    
                    <svg id="yearChart">
                    </svg>

                    <svg id="svg"></svg>
      </div> <!-- tangle end -->
    </div> 






</body>
</html>
 