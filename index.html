
<!DOCTYPE html>
<html>

   <head>
   <meta charset="UTF-8">



<script src='js/Tangle-0.1.0/Tangle.js' type='text/javascript'></script>
<link rel="stylesheet" href='js/Tangle-0.1.0/TangleKit/TangleKit.css' type='text/css'></style>
<script src='js/Tangle-0.1.0/TangleKit/mootools.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/sprintf.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/BVTouchable.js' type='text/javascript'></script>
<script src='js/Tangle-0.1.0/TangleKit/TangleKit.js' type='text/javascript'></script>
<script src='js/d3.min.js'></script>
<script src='js/crossfilter.min.js'></script>
<script src='js/helpers.js'></script>



<style type='text/css'>


#controls {
    position: absolute;
    left: 300px;    
    width: 800px;
    height: 400px;
    font-size: 24px;
    text-align: left; 
    margin-left:0px;
    margin-right:0px;
    margin-top:20px;
    margin-bottom:-20px;
    font-size: 26px;    
}


#timeline {
    position: absolute;
    width: 0px;
    height: 20px;
    border: none;
/*    border-radius: 15px; */
    background-color: lightgreen;
}

#yearChart {
    position: absolute;
    top: 400px;
    height: 100px;
    width: 800px;
    left: 0px;    
}

#svg {
    display: inline;
    position: absolute;
    width: 800px;
    height: 600px;  
    left: 150px;
    top: 500px;
    background-color: white;
}


#ageChart {
    position: absolute;
    height: 600px;
    width: 150px;  
    left: 0px;
    top: 0px;
    background-color: white;
}

.widget {
    position: relative;
    margin-top: 0px;
    width: 800px;
    /* height: 600px; */
    /* font-family: Serif, Georgia; */
    font-size: 22px;
}


/* .widget:hover { */
/*     background-color: #e0e0e0; */
/* } */

.widgetTable { 
   width: 600px;
   border-spacing: 5px;
   border: 0px solid grey;
   border-collapse: collapse;
   display: inline-block;
   
}

.valueCell {
   border: 0px;
   text-align: right;
   border-bottom: 1px dotted black;
}

.rowName {
   font-weight: bold;
   text-align: right;
   border: 0px;
   border-bottom: 1px dotted black;
}


.colName {
   font-weight: bold;
   text-align: right;
   border: 2px;
   border-bottom-style: solid;
}

.emptyCell {
   border: 0px;
}

.asterisk {
   font-style: italic;
}

indicatorBar {
    background-color: #b5b5b5;
}

#increase {
    color: green;
}

#decrease {
    color: red;
}

.TKAdjustableNumber {
    color: #00b5e2;
    font-weight: bold;
}

.TKAdjustableNumberHelp {
    color: #00b5e2;
    font-size: 18px;
}

.selector {
    line-height: 40px;
    text-align: center;
}

.selector > * {
    margin-left: 0px;
    margin-right: 10px;
}


.selectorItem {
    border: none;
    border-radius: 15px; 
    font-size: 24px;
    padding-left: 15px;
    padding-right: 10px;
    cursor: pointer;
    }
    
.selector:hover {
    
}    

.hide {
    background-color: rgba(224,224,224,0.6);
    color: #b5b5b5;    
}

.hide:hover {
    background-color: rgba(224,224,224,0.8);
}

.show {
    background-color: rgba(0,181,226,0.4);       
}

.show:hover {
    background-color: rgba(0,181,226,0.8);       
}

.xAxis path {
    fill: none;
    stroke: none;
}


.xAxis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.xAxis text {
    font-family: sans-serif;
    font-size: 11px;
}


.brush .extent {
  stroke: #000;
  fill-opacity: .125;
  fill: #b5b5b5;
  shape-rendering: crispEdges;
}

.resize {
    width: 10px;
    height: 150px;
    fill: purple;
    fill-opacity: 0.3;
}


#widgetContainer {
    position: absolute;
    width: 800px;
    /* height: 1600px;   */
    left: 300px;
    top: 550px;
    /* background-color: khaki; */
}

#inactive {
    visibility: hidden;
    height: 0px;
}

</style>








<script type='text/javascript'>







var outerWidth = 500,
    outerHeight = 400,
    margin = {top: 30, right: 30, bottom: 50, left: 50},
    width = outerWidth - margin.left - margin.right,
    height = outerHeight - margin.top - margin.bottom;





var update = function(houseData, maxHouses){



var svgHeight = 500;


var housePoints = [[100,50], [100,150], [80,150], [150,200],
                  [220,150], [200,150], [200,50], [100,50]];

console.log('number of houses => ' + houseData.length);

var transitionTime = 30;

var houseScaleX = d3.scale.linear().domain([1,maxHouses]).range([0,500]);  //---//
//d3.select('#svg').selectAll('polygon').remove();

var house = d3.select('#svg').selectAll('polygon')
                            .data(houseData, function(d,i) { return d; });
                            
                        house
                            .enter()
                            .append("polygon")
                            .attr("points", housePoints.map(function(d) { 
                                    var x = d[0],
                                    y = svgHeight - d[1] + 100;
                                    return [x,y]; }))                                  
                            .attr("stroke", "black")
                            .attr("stroke-width", 1)
                            .attr("fill", "#00b5e2")
                            .attr("transform", function(d,i) { return "translate(" + (houseScaleX(d)) + ")"; })
                            .attr('n', function(d,i) { return i; })
                            .style('fill', 'Bisque');                               
                             
                            
                        house.exit()
                            .transition().duration(transitionTime * 5)
                            .style('fill', 'orange')
                            .style('fill-opacity', 0)
                            .style('stroke-opacity', 0)
                            .remove();

   }



</script>

   </head>

  <body>




    <div id="inactive">

    <!-- Productivity -->
    <div id="productivityWidget" class="widget">
      <p>
         Ett mått på förmågan att finansiera det gemensamma är försörjningskvoten. Detta är det antal personer varje individ i yrkesverksam ålder måste försörja, inklusive sig själv. 
         <span data-var="npp"></span> fler i åldrarna 20-64 fram till  
         <span data-var='end'></span> innebär att 
         <span data-var="nps_" data-format="%.1f">%</span> av de nya malmöborna är i yrkesverksam ålder. 
         Om vi räknar på de nya malmöborna utan att ta hänsyn till befintlig befolkning så är försörjningskvoten 
         <span data-var="ndr" data-format="%.2f"></span>. Försörjningskvoten är betydligt högre bland de nya Malmöborna och framförallt under de närmaste 10 åren. Därefter sker ett något större relativt tillskott i de yrkesaktiva åldrarna, men kvoten är fortfarande betydligt högre än i den befintliga befolkningen. Att en relativt stor del av tillväxten sker i de icke yrkesverksamma åldrarna innebär att dagens försörjningskvot på 1.6 väntas öka till <span data-var='fdr' data-format="%.2f"></span>, enbart baserat på befolkningens åldersfördelning. Nedan håller vi den nuvarande befolkningen konstant och simulerar vad som händer när befolkningstillväxten läggs till.  
      </p>

      <p>
        <table class="widgetTable" height='200' cellspacing='0' border='1'>
           <tr> 
              <th class="emptyCell"></th>
              <th class="colName">Befolkning 2014</th>
              <th class="colName">Tillskott 2015-<span data-var='end'></span> </th>
              <th class="colName">Befolkning <span data-var='end'></span></th>
           </tr>
           <tr>
              <td class="rowName">0-100 år</td>
              <td class="valueCell"> <span data-var='cp'></span> </td>
              <td class="valueCell"> <span data-var='np'></span> </td>
              <td class="valueCell"> <span data-var='fp'></span> </td>
           </tr>
           <tr> 
              <td class="rowName">20-64 år</td>
              <td class="valueCell"> <span data-var='cpp'></span> </td>
              <td class="valueCell"> <span data-var='npp'></span> </td>
              <td class="valueCell"> <span data-var='fpp'></span> </td>
           </tr>
           <tr> 
              <td class="rowName">Andel 20-64 år</td>
              <td class="valueCell"><span data-var='cps_' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='nps_' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='fps_' data-format="%.1f">%</span></td>
           </tr>
           <tr> 
              <td class="rowName">Försörjningskvot</td>
              <td class="valueCell"> <span data-var='cdr' data-format="%.2f"></span>* </td>
              <td class="valueCell"> <span data-var='ndr' data-format="%.2f"></span> </td>
              <td class="valueCell"> <span data-var='fdr' data-format="%.2f"></span> </td>
           </tr>
           <tr> 
              <td class="rowName">Vikt</td>
              <td class="valueCell"> <span data-var='cw_' data-format="%.0f">%</span> </td>
              <td class="valueCell"> <span data-var='nw_' data-format="%.0f">%</span> </td>
              <td class="valueCell"> 100% </td>
           </tr>
        </table>


        <br />
      <small class="asterisk"> * jfr 2014: Stockholm 1.56, Göteborg 1.58, Sverige 1.73 </small>
      </p>

      <p>
      Andelen i yrkesaktiv ålder är ett trubbigt mått, på så sätt att alla som kan lönearbeta också antas göra det. 
      När vi justerar för sysselsättningsgrad blir den uppskattade försörjningsbördan betydligt högre. För närvarande är  
      <span data-var='cer'>%</span> av alla malmöbor sysselsatta (2013). Om vi antar att sysselsättningsgraden bland de nya invånarna förändras med <span data-var='employmentRateChange' class='TKAdjustableNumber' data-min='-15' data-max='15'>%</span>  
      (=<span data-var='ner'>%</span>) kommer den justerade försörjningsbördan att vara  
      <span data-var='fadr' data-format='%.2f'></span>, att jämföra med dagens <span data-var='cadr' data-format='%.2f'></span>.
      </p>

      <p>
        <table class="widgetTable" height='200' cellspacing='0' border='1'>
           <tr> 
              <th class="emptyCell"></th>
              <th class="colName">Befolkning 2014</th>
              <th class="colName">Tillskott 2015-<span data-var='end'></span> </th>
              <th class="colName">Befolkning <span data-var='end'></span></th>
           </tr>
           <tr>
              <td class="rowName">0-100 år</td>
              <td class="valueCell"> <span data-var='cp'></span> </td>
              <td class="valueCell"> <span data-var='np'></span> </td>
              <td class="valueCell"> <span data-var='fp'></span> </td>
           </tr>
           <tr> 
              <td class="rowName">20-64 år och<br>förvärvsarbetande</td>
              <td class="valueCell"> <span data-var='capp'></span> </td>
              <td class="valueCell"> <span data-var='napp'></span> </td>
              <td class="valueCell"> <span data-var='fapp'></span> </td>
           </tr>
           <tr> 
              <td class="rowName"> Sysselsättningsgrad </td>
              <td class="valueCell"><span data-var='cer' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='ner' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='fer' data-format="%.1f">%</span></td>
           </tr>
           <tr> 
              <td class="rowName">Justerad andel </td>
              <td class="valueCell"><span data-var='caps_' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='naps_' data-format="%.1f">%</span></td>
              <td class="valueCell"><span data-var='faps_' data-format="%.1f">%</span></td>
           </tr>
           <tr> 
              <td class="rowName">Justerad kvot</td>
              <td class="valueCell"> <span data-var='cadr' data-format="%.2f"></span>* </td>
              <td class="valueCell"> <span data-var='nadr' data-format="%.2f"></span> </td>
              <td class="valueCell"> <span data-var='fadr' data-format="%.2f"></span> </td>
           </tr>
        </table>


        <br />
        <small class="asterisk"> * jfr 2013: Stockholm ., Göteborg ., Sverige . </small>
        <!-- Sysselsättningsgrad 2013: -->
        <!-- Stockholm 77,82 %, Malmö 64,03 %, Göteborg: 72,95 % -->
        <!-- Relatera till befolkning 2013 -->
        <br /> <br />

        <p> 
        Den stora skillnaden mellan de två räknesätten understryker sysselsättningens vikt för att uppskatta den faktiska försörjningsbördan. Befolkningsprognosen säger något om antal individer i respektive ålder vid ett givet årsskifte, men andra slutsatser om befolkningens sammansättning kräver sekundära uppgifter och antaganden. Män lönearbetar i något högre utsträckning än kvinnor (61% resp. 56%)* och skillnaderna är stora mellan åldersgrupper, där 20-24åringar lönearbetar minst och 45-54åringar mest (58% resp. 84%).  
        </p>

        <p>
        Som enskild variabel är också geografiskt ursprung mycket utslagsgivande. Bland sverigefödda är förvärvsfrekvensen högst med 82% medan den bland de med afrikanskt födelseland är ungefär hälften, 45%. Självklart är det så att både kön, ålder och etnicitet får sin förklaringskraft av att de samvarierar med andra faktorer. Att invandringen ur olika grupper har skett av olika skäl och varierat över tid påverkar också skillnaderna mellan arbetstagare av olika etnicitet. Högst är förvärvsfrekvensen bland dem som invandrade på 80- och 90-talen (cirka 65%), något lägre för nytillkomna på 2000-2009 (knappt 56%) och lägst bland dem som invandrat sedan 2010 (37%). 
         
      <p>
      <small class="asterisk"> * Dessa och efterföljande andelar gäller riket som helhet 2013, men mönstren går igen på lokal nivå. Alla siffror finns att hämta i <a href="http://www.statistikdatabasen.scb.se/pxweb/sv/ssd/START__AM__AM0207__AM0207H/?rxid=3008aa41-85eb-400b-aa88-6797c8700809">SCB:s öppna statistikdatabas</a>.  </small><br>
        <small class="asterisk"> ** För en historisk och teoretisk genomgång av samhällets ekonomiska omdaning och hur den påverkat förutsättningarna för integration, se t ex <a href="https://www.google.se/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&cad=rja&uact=8&ved=0CCAQFjAAahUKEwjUy_HA3dXIAhVHhywKHZzZAk8&url=http%3A%2F%2Fmalmo.se%2Fdownload%2F18.6e1be7ef13514d6cfcc80006006%2Fstigendal_20120130.pdf&usg=AFQjCNHtUj7uuGDw8ZrkrX1vWvIQshwTPA&sig2=XnpAMBRsKRH45x1JkRfGJw">Stigendal (2012), De två kunskapsstäderna</a> (diskussionsunderlag för Malmökommissionen). </small><br>
      </p>     

      <p>
      Vidare information:
      <li> <a href="http://malmo.se/download/18.51821d07143bab87ba74e7b/1391423903290/Arbetsl%C3%B6shet+och+syssels%C3%A4ttning+i+Malm%C3%B6+2013.pdf">Arbetslöshet och sysselsättning i Malmö 2013 - en översikt</a> </li>
      <li> <a href="http://malmo.se/download/18.527439081213a05d5d0800010970/INSIKT+tillv%C3%A4xt++och+skattekraft.pdf">Stadskontorets vårrapport 2009: Tema Tillväxt och Skattekraft</a> </li>
      </p>


    </div>
    <!-- /Productivity -->


    <!-- Housing -->
    <div id="housingWidget" class="widget">

       <p>I Boverkets rapport <i>Behov av bostadsbyggande</i> görs en prognos över det regionala bostadsbehovet under perioden 2015-2025. För att skatta detta behov använder Boverket den så kallade hushållskvotsmetoden, som utgår från befolkningstillväxt och åldersspecifika hushållskvoter. Grundläggande antaganden är för det första att varje hushåll behöver en bostad, för det andra att antalet hushåll beror av befolkningens ålderssammansättning. Hänsyn tas också till rivningar och lediga lägenheter. Därutöver behövs en så kallad bostadsreserv för att bostadsmarknadens ska fungera. Den är ett överskott som antas vara 1 % av befintligt bostadsbestånd. </p>


                        <table class='widgetTable' cellspacing='0'>
                           <th class='colName'>Åldersgrupp</td>
                           <th class='colName'>Befolkningstillväxt</td>
                           <th class='colName'>Hushållskvot</td>
                           <th class='colName'>Hushåll/person (=1/kvot)</td>
                           <th class='colName'>Bostadsbehov <span data-var='start'></span>-<span data-var='end'></span></td>
                           </th>
                        <tr>
                           <td class='rowName'>15-19</td>
                           <td class='valueCell'><span data-var='n15_19'></span></td>
                           <td class='valueCell'><span data-var='hhr15_19'></span></td>
                           <td class='valueCell'><span data-var='hh15_19' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh15_19'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>20-24</td>
                           <td class='valueCell'><span data-var='n20_24'></span></td>
                           <td class='valueCell'><span data-var='hhr20_24'></span></td>
                           <td class='valueCell'><span data-var='hh20_24' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh20_24'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>25-34</td>
                           <td class='valueCell'><span data-var='n25_34'></span></td>
                           <td class='valueCell'><span data-var='hhr25_34'></span></td>
                           <td class='valueCell'><span data-var='hh25_34' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh25_34'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>35-44</td>
                           <td class='valueCell'><span data-var='n35_44'></span></td>
                           <td class='valueCell'><span data-var='hhr35_44'></span></td>
                           <td class='valueCell'><span data-var='hh35_44' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh35_44'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>45-54</td>
                           <td class='valueCell'><span data-var='n45_54'></span></td>
                           <td class='valueCell'><span data-var='hhr45_54'></span></td>
                           <td class='valueCell'><span data-var='hh45_54' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh45_54'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>55-64</td>
                           <td class='valueCell'><span data-var='n55_64'></span></td>
                           <td class='valueCell'><span data-var='hhr55_64'></span></td>
                           <td class='valueCell'><span data-var='hh55_64' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh55_64'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>65-69</td>
                           <td class='valueCell'><span data-var='n65_69'></span></td>
                           <td class='valueCell'><span data-var='hhr65_69'></span></td>
                           <td class='valueCell'><span data-var='hh65_69' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh65_69'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>70-74</td>
                           <td class='valueCell'><span data-var='n70_74'></span></td>
                           <td class='valueCell'><span data-var='hhr70_74'></span></td>
                           <td class='valueCell'><span data-var='hh70_74' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh70_74'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>75-79</td>
                           <td class='valueCell'><span data-var='n75_79'></span></td>
                           <td class='valueCell'><span data-var='hhr75_79'></span></td>
                           <td class='valueCell'><span data-var='hh75_79' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh75_79'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>80-</td>
                           <td class='valueCell'><span data-var='n80_100'></span></td>
                           <td class='valueCell'><span data-var='hhr80_100'></span></td>
                           <td class='valueCell'><span data-var='hh80_100' data-format='%.2f'></span></td>
                           <td class='valueCell'><span data-var='nhh80_100'></span></td>
                        </tr>

                        <tr>
                           <td class='rowName'>Summa</td>
                           <td class='valueCell'><span data-var='nPeople'></span></td>
                           <td class='valueCell'>-</td>
                           <td class='valueCell'>-</td>
                           <td class='valueCell'><span data-var='nhh'></span></td>
                        </tr>
                        </table>

<br />
<br />

                        <table cellspacing='0' style='text-align:center;'>
                           <tr>
                              <td bgcolor="lightblue">Befolkningsförändring</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td>*</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td bgcolor="lightblue">Hushållskvoter</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td>=</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td bgcolor="#0099FF">Hushållsförändring</td>
                              <td><span data-var='nhh'></span></td>
                           </tr>
                           <tr>
                              <td>+</td>
                              <td>+</td>
                           </tr>
                           <tr>
                              <td bgcolor="lightgrey">Rivning av befintligt bestånd</td>
                              <td><span data-var='demolitionPerYear' class='TKAdjustableNumber' data-min='0' data-max='500' data-step='50' data-format='%.3d'> lägenheter årligen</span> * <span data-var='nYears'> år</span> = <span data-var='demolition'></span></td>
                           </tr>
                           <tr>
                              <td>-</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td bgcolor="lightgrey">Lediga lägenheter</td>
                              <td><span data-var='availableHousing' class='TKAdjustableNumber' data-min='0' data-max='500' data-step='50'></td>
                           </tr>
                           <tr>
                              <td>+</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td bgcolor="lightgrey">"Bostadsreserv", 1% av bef. bestånd**</td>
                              <td><span data-var='housingResidual'></span></td>
                           </tr>
                           <tr>
                              <td>=</td>
                              <td></td>
                           </tr>
                           <tr>
                              <td bgcolor="#0099FF"><strong>Förväntat byggbehov <span data-var='start'></span>-<span data-var='end'></strong></td>
                              <td><strong><span data-var='housingNeed'></span></strong></td>
                           </tr>
                        </table>



       <p>
         Det demografiskt drivna bostadsbehovet <span data-var='start'></span>-<span data-var='end'> beräknas till 
         <span data-var='housingNeed' data-format='%.5d'></span> färdigställda lägenheter. 
         Fördelat på <span data-var='nYears' data-format='%.2d'> år</span> motsvarar det en byggtakt på cirka 
         <span data-var='housingNeedPerYear' data-format='%.4d'></span> lägenheter/år varav de första behöver vara inflyttningsklara från och med 1 januari <span data-var='start'></span>. Under de senaste 10 åren har det i snitt byggstartats nära 1300 bostäder i Malmö. Detta motsvarar det marknadsdrivna bostadsbyggandet. För att producera bostäder i takt med den förväntade befolkningstillväxten krävs ytterligare <span data-var='productionChange' data-format='%.4d'></span> lägenheter per år. Detta är utan hänsyn till befintlig befolkning och det underskott som redan finns.
       </p>
      <p> 
      <small class="asterisk"> * <a href="http://www.boverket.se/globalassets/publikationer/dokument/2015/behov-av-bostadsbyggande.pdf">Behov av bostadsbyggande, Boverket 2015</a>.</small><br>
      <small class="asterisk"> ** Bostadsbestånd i Malmö 2014 enligt SCB: 154 900, varav 26 500 småhus, 119 800 flerbostadshus, 5 600 specialbostäder och 3 000 övriga hus. <a href="http://www.statistikdatabasen.scb.se/pxweb/sv/ssd/START__BO__BO0104/BO0104T01/?rxid=5ecfc620-edb3-4025-99ee-fc27540bf27f">Tabell</a>.  </small><br>

      </p>

    </div>
    <!-- /Housing -->


    <!-- Preschool -->
    <div id="preschoolWidget" class="widget">
         <span data-var="nPreschoolChildren"></span> nya 1-5åringar motsvarar 
         <span data-var='nPreschools'> förskolor om varje enhet rymmer </span> 
         <span data-var='childrenPerPreschool' class="TKAdjustableNumber" data-min="20" data-max="60"> barn.</span><br>
         <span id="preschoolBar" class="indicatorBar"></span>
    </div>
    <!-- /Preschool -->

    <!-- Primary school -->
    <div id="primaryschoolWidget" class="widget">
         <span data-var="nPrimaryschoolChildren"></span> nya 6-15åringar skapar ett behov av 
         <span data-var='nPrimaryschools'> nya grundskolor om varje enhet rymmer </span>
         <span data-var='childrenPerPrimaryschool' class="TKAdjustableNumber" data-min="300" data-max="1000" data-step="100"> barn.</span>
    </div>
    <!-- /Primary school -->



    <!-- Demography -->
    <div id="demographyWidget" class="widget">
                    <svg id="ageChart"></svg>
                    <span style="left:150px; width:650px; position:absolute;">
                        De demografiska förändringarna...
                        <p> 

                        <table class='widgetTable' cellspacing='0'>
                           <th class='colName'>Åldersgrupp</td>
                           <th class='colName'>Förändring <span data-var='start'></span>-<span data-var='end'></span></td>
                           </th>
                        <tr>
                           <td class='rowName'>0</td>
                           <td class='valueCell'><span data-var='n0'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>1-5</td>
                           <td class='valueCell'><span data-var='n1_5'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>6-15</td>
                           <td class='valueCell'><span data-var='n6_15'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>16-19</td>
                           <td class='valueCell'><span data-var='n16_19'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>20-64</td>
                           <td class='valueCell'><span data-var='n20_64'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>65-79</td>
                           <td class='valueCell'><span data-var='n65_79'></span></td>
                        </tr>
                        <tr>
                           <td class='rowName'>80-100</td>
                           <td class='valueCell'><span data-var='n80_100'></span></td>
                        </tr>
                        </table>

                        </p>
                    </span>
                    <br />


    </div>
    <!-- /Demography -->

    <!-- Upper secondary -->
    <div id="uppersecondaryWidget" class="widget">
      Gymnasieskolor
    </div>
    <!-- /Upper secondary -->

    <!-- Care -->
    <div id="careWidget" class="widget">
       Vård och omsorg<br>
            <span data-var='start'></span>-<span data-var='end'></span>:
         <p>
         <span data-var='n65_79'></span> i åldrarna 65-79<br>
         <span data-var='n80_100'></span> i åldrarna 80+ 
         </p>
         <p>innebär att...</p>
    </div>
    <!-- /Care -->

    <!-- Business -->
    <div id="businessWidget" class="widget">
      Näringsliv
    </div>
    <!-- /Business -->

    <!-- Infrastructure -->
    <div id="infrastructureWidget" class="widget">
      Infrastruktur och förbindelser
         <p>Höghastighetsjärnväg, Öresundsmetro, lokal kollektivtrafik...</p>
    </div>
    <!-- /Infrastructure -->

    <!-- Regional -->
    <div id="regionalWidget" class="widget">
      Regionala prognoser
      <p>Skåne, Köpenhamn och övriga Öresundsregionen</p>
    </div>
    <!-- /Regional -->



</div>


   <div id='controls'>
   
         <h1 style="display:inline; margin-left:50px; font-family: MyriadPro-Bold, Garamond, Arial, Helvetica, sans-serif">Nya malmöbor 2015-2040</h1>
        <p id="">

                <span id='fromStart' class='TKIf' data-var='fromStart'>Fram till </span> 
                <span id='notFromStart' class='TKIf' data-var='notFromStart'>
                  Under <span data-var="start" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
                  - </span> 
                <span data-var="end" class="TKAdjustableNumber" data-min="2015" data-max="2040"></span>
                (en <span data-var="nYears"></span>-årsperiod)
                väntas <span id='group'>invånarantalet</span> 
                <span id='increase' class='TKIf' data-var='increase'>öka</span> 
                <span id='decrease' class='TKIf' data-var='decrease'>minska</span> 
                med <span data-var='change'></span> individer i åldrarna 
                <span data-var='minAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span> - 
                <span data-var='maxAge' class="TKAdjustableNumber" data-min="0" data-max="100"></span>. 
                Totalt tillkommer <span data-var='nAll'></span> nya malmöbor.
        </p>


         <p id="sections" data-var="sectionVisible" class="selector TKSwitchActive" data-class1="show" data-class2="hide">
         <span id="demography" class="selectorItem show"> De demografiska förändringarna </span> påverkar 
                <span id="preschool" class="selectorItem hide"> Förskola </span>
                <span id="primaryschool" class="selectorItem hide"> Grundskola </span>
                <span id="uppersecondary" class="selectorItem hide"> Gymnasieskola </span>
                <span id="housing" class="selectorItem hide"> Bostäder </span>
                <span id="care" class="selectorItem hide"> Vård och omsorg </span>
                <span id="productivity" class="selectorItem hide"> Skattekraft </span>
                <span id="business" class="selectorItem hide"> Näringsliv </span>
                <span id="infrastructure" class="selectorItem hide"> Infrastruktur </span>
                <span id="regional" class="selectorItem hide"> Regionen </span>
         </p>
         
         <p id="ages" data-var="ageVisible" class="selector TKSwitchActive" data-class1="show" data-class2="hide">
                <span id="totalt" class="selectorItem hide"> totalt </span>
                || 
                <span id="totalt" class="selectorItem hide"> 0 </span>
                <span id="totalt" class="selectorItem hide"> 1-5 </span>
                <span id="totalt" class="selectorItem hide"> 6-15 </span>
                <span id="totalt" class="selectorItem hide"> 16-19 </span>
                <span id="totalt" class="selectorItem hide"> 20-64 </span>
                <span id="totalt" class="selectorItem hide"> 65-79 </span>
                <span id="totalt" class="selectorItem hide"> 80+ </span>
         </p>

                    <svg id="yearChart">
                       <g id="gBrush" data-var="xExtent" class="TKBrush brush" data-min="2015" data-max="2040" data-x1="2015" data-x2="2019"></g>
                    </svg>

      </div> <!-- tangle end -->


         <div id="widgetContainer">

                    <!-- <svg id="ageChart"></svg> -->

                    <!-- <svg id="svg"></svg> -->
                    
    </div> 
    


<script type='text/javascript'>


// var round5 = roundn(5);
// var round50 = roundn(50);

var demographyTangle = new Tangle(document.getElementById('demographyWidget'), {
    initialize: function () { console.log('DEMOGRAPHY INITIALIZED...');
        
                              this.start = 2015;
                              this.end = 2040;
                              this.n0 = 0;
                              this.n1_5 = 0;
                              this.n6_15 = 0;
                              this.n16_19 = 0;
                              this.n20_64 = 0;
                              this.n65_79 = 0;
                              this.n80_100 = 0;
                            },
    update:     function () {  
                           this.c = this.a + this.b;
       console.log('DEMOGRAPHY UPDATED...');
 }
});



var preschoolTangle = new Tangle(document.getElementById('preschoolWidget'), {
    initialize: function () { console.log('PRESCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPreschoolChildren = 0;
                              this.childrenPerPreschool = 40;
                              this.round = roundn(5);
                            },
    update:     function () { this.perCapita= 1/this.childrenPerPreschool;
                              this.nPreschools = Math.ceil(this.nPreschoolChildren * this.perCapita);
 }
});

var primaryschoolTangle = new Tangle(document.getElementById('primaryschoolWidget'), {
    initialize: function () { console.log('PRIMARY SCHOOL INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.nPrimaryschoolChildren = 0;
                              this.childrenPerPrimaryschool = 500;
                              this.round = roundn(5);
                            },
    update:     function () { this.perCapita = 1/this.childrenPerPrimaryschool;
                              this.nPrimaryschools = Math.ceil(this.nPrimaryschoolChildren * this.perCapita);
 }
});


var careTangle = new Tangle(document.getElementById('careWidget'), {
    initialize: function () { console.log('CARE INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.n65_79 = 0;
                              this.n80_100 = 0;
                            },
    update:     function () {  
                              console.log('CARE UPDATED...');
 }
});

var productivityTangle = new Tangle(document.getElementById('productivityWidget'), {
    initialize: function () { console.log('PRODUCTIVITY INITIALIZED...');
        
                              this.start = 2015; 
                              this.end = 2040;
                              this.cp = 318107;
                              this.cpp = 198463;
                              this.cps = this.cpp / this.cp;
                              this.cps_ = this.cps * 100;
                              this.cdr = 1 / this.cps;
                              this.cw = 0;
                              this.nAll = 0;
                              this.np = 0;
                              this.npp = 0;
                              this.round = roundn(5);

                              this.employmentRateChange = 0;
                              this.cer = 64;
                              this.capp = Math.round(this.cpp * (this.cer / 100));
                              this.caps = this.capp / this.cp;
                              this.caps_ = this.caps * 100;
                              this.cadr = 1 / this.caps;
                  // c = current, n = new, f = future (current + new)
                  // p = population, pp = productive part, ps = productive part share of population, dr = dependency ratio
                  // er = employment rate, w = weight, a = adjusted (multiplied by employment rate), _ = for display

                            },
    update:     function () {  
                              this.fp = this.cp + this.np;
                              this.cw = this.cp / this.fp;
                              this.cw_ = this.cw * 100;
                              this.nw = 1 - this.cw;
                              this.nw_ = this.nw * 100;

                              this.nps = this.npp / this.np;
                              this.nps_ = this.nps * 100;
                              this.ndr = 1 / this.nps;
                              this.ner = this.cer + this.employmentRateChange;

                              this.napp = Math.round(this.npp * (this.ner / 100));
                              this.naps = this.napp / this.np;
                              this.naps_ = this.naps * 100;
                              this.nadr = 1 / this.naps;

                              this.fpp = this.cpp + this.npp;
                              this.fps = this.fpp / this.fp;
                              this.fps_ = this.fps * 100;
                              this.fdr = 1 / this.fps;

                              // adjusted figures, where changes in employment rate only applies to new population
                              this.fapp = Math.round(this.capp + this.napp);
                              this.faps = (this.cw * this.caps) + (this.nw * this.naps);
                              this.faps_ = this.faps * 100;
                              this.fadr = 1 / this.faps;
                              this.fer = (this.cw * this.cer) + (this.nw * this.ner);
            console.log('PRODUCTIVITY UPDATED...');
 }
});



var housingTangle = new Tangle(document.getElementById('housingWidget'), {
    initialize: function () { this.start = 2015;
                              this.end = 2040;
                              this.nYears = this.end - this.start + 1;
                              this.nPeople = 0;
                              this.appartments = 0;
                              this.peoplePerAppartment = 3;
                              this.appartmentsPerYear = 0;
                              this.appartmentsPerYearChange = 0;
                              this.plus = true;
                              this.appartmentsPerHouse = 1000;
                              this.maxHouses = 150;                 
                              this.round = roundn(5);

                              this.demolitionPerYear = 50;
                              this.currentProduction = 1300;
                              this.totalHousing = 154900;
                              this.housingResidual = this.totalHousing * 0.01;
                              this.availableHousing = 150;

                              this.n15_19 = this.n20_24 = this.n25_34 = this.n35_44 = 
                              this.n45_54 = this.n55_64 = this.n65_69 = this.n70_74 = 
                              this.n75_79 = this.n80_100 = 0;


                  this.hhr15_19 = .02;  
                  this.hhr20_24 = .45;
                  this.hhr25_34 = .59;  
                  this.hhr35_44 = .61;
                  this.hhr45_54 = .68  
                  this.hhr55_64 = .63;
                  this.hhr65_69 = .61;  
                  this.hhr70_74 = .66;
                  this.hhr75_79 = .66;  
                  this.hhr80_100 = .82;  

                  this.hh15_19 = 1/.02;  
                  this.hh20_24 = 1/.45;
                  this.hh25_34 = 1/.59;  
                  this.hh35_44 = 1/.61;
                  this.hh45_54 = 1/.68  
                  this.hh55_64 = 1/.63;
                  this.hh65_69 = 1/.61;  
                  this.hh70_74 = 1/.66;
                  this.hh75_79 = 1/.66;  
                  this.hh80_100 = 1/.82;  
                            },
    update:     function () { this.nYears = this.end - this.start + 1;

                              // this.perCapita = 1/this.peoplePerAppartment;
                              // this.appartments = Math.ceil(this.nPeople * this.perCapita);
                              // this.appartmentsPerYear = this.round(this.appartments/this.nYears);
                              // this.appartmentsPerYearChange = this.appartmentsPerYear - 1300;  
                              //    // currently producing 1300 new appartments/year
                              // this.plus = this.appartmentsPerYearChange >= 0;
                              // document.getElementById('appartmentsPerYearChange').style.color = this.appartmentsPerYearChange >= 0 ? 'red' : 'green'; 


                  this.nhh15_19 = Math.round(this.n15_19 * this.hhr15_19);  
                  this.nhh20_24 = Math.round(this.n20_24 * this.hhr20_24);
                  this.nhh25_34 = Math.round(this.n25_34 * this.hhr25_34);  
                  this.nhh35_44 = Math.round(this.n35_44 * this.hhr35_44);
                  this.nhh45_54 = Math.round(this.n45_54 * this.hhr45_54);  
                  this.nhh55_64 = Math.round(this.n55_64 * this.hhr55_64);
                  this.nhh65_69 = Math.round(this.n65_69 * this.hhr65_69);  
                  this.nhh70_74 = Math.round(this.n70_74 * this.hhr70_74);
                  this.nhh75_79 = Math.round(this.n75_79 * this.hhr75_79);  
                  this.nhh80_100 = Math.round(this.n80_100 * this.hhr80_100);

                  this.nhh = this.nhh15_19 + this.nhh20_24 + this.nhh25_34 + this.nhh35_44 +
                            this.nhh45_54 + this.nhh55_64 + this.nhh65_69 + this.nhh70_74 +
                            this.nhh75_79 + this.nhh80_100;

                  this.demolition = this.demolitionPerYear * this.nYears; 
                  this.housingNeed = this.nhh + this.demolition - this.availableHousing + this.housingResidual; 
                  this.housingNeedPerYear = this.housingNeed / this.nYears;
                  this.productionChange = this.housingNeedPerYear - this.currentProduction;

 }
});





                d3.json("data/data.json", function(error, json) {
                    if (error) return console.warn(error);
                    //console.log(json);
                    json.forEach(function(d) {
                        d.age = +d.age;
                    })




var rootElement = document.getElementById('controls');
var model = {
initialize: function() {


                  this.start = 2015;
                  this.end = 2019;
                  this.xExtent = [this.start,this.end];
                  this.firstYear = 2015;
                  this.lastYear = 2040;
                  this.nYears = this.end - this.start + 1;
                  this.minAge = 0;
                  this.maxAge = 100;

                    this.data = json;
                    this.changeData = this.data.slice(101, this.data.length);
                    this.xf = crossfilter(this.changeData);
                    this.yearDimension = this.xf.dimension(function(d) { return d.year; });
                    this.ageDimension = this.xf.dimension(function(d) { return d.age; });
                    this.popDimension = this.xf.dimension(function(d) { return d.s; });

                  // this.ageFilters = [[0,101],[0,1],[1,6],[6,16],[16,20],[20,65],[65,80],[80,101]];
                  this.ageVisible = 0;
//-----//
                  this.yearFilter = [this.start, this.end + 1];
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  // this.ageFilter = this.ageFilters[this.ageVisible]);
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });                  
//-----//
                    
                    //this.startData = this.data.slice(0,102);
                    //console.table(this.startData);                  
                    //this.startxf = crossfilter(this.startData);
                    //this.startYearPop = this.startxf.dimension(function(d) { return d.age; });

//-----//

var staticSettings = {
  start: this.firstYear,
  end: this.lastYear,
  barSize: 75,
  width: 800,
  height: 150,
  xLabel: 'År',
  gap: 0.05,
  tickValues: range(2015,2040,5),
  xDomain: range(this.firstYear,this.lastYear),
  yDomain: [0,7000],
  data: this.changeByYear.all()
  };

var dynamicSettings = {
  xmin: this.start,
  xmax: this.end,  
};


this.yearChart = horizontalBarChart('#yearChart', staticSettings, dynamicSettings);
this.yearChart.render();

this.sectionVisible = 0;


this.widgets = ["demographyWidget", "preschoolWidget", "primaryschoolWidget",  
                "uppersecondaryWidget", "housingWidget", "careWidget", "productivityWidget",  
                "businessWidget", "infrastructureWidget", "regionalWidget"];

document.getElementById('widgetContainer').appendChild(document.getElementById(this.widgets[this.sectionVisible]));

//-----//


var ss = {
  start: 0,
  end: 100,
  barSize: 75,
  width: 150,
  height: 600,
  xLabel: 'Ålder',
  gap: 0.15,
  tickValues: range(0,100,5),
  xDomain: range(0,100),
  yDomain: [0,2500],
  data: this.changeByAge.all()
  };

var ds = {
  xmin: this.minAge,
  xmax: this.maxAge,  
};


this.ageChart = verticalBarChart('#ageChart', ss, ds);
this.ageChart.render();


//-----//

this.sectionVisible = 4;
// this.ageVisible = 0;

//-----//

                 
                 
            },
update: function() {

                  this.fromStart = (this.sectionVisible === 6);
                  this.notFromStart = !this.fromStart;

                  this.start = this.end - this.start >= 0 ? this.start : this.end;
                  this.end = this.end - this.start >= 0 ? this.end : this.start;

                  this.start =  this.fromStart ? this.firstYear : this.start;
                  this.xExtent = [this.start, this.end];

                  this.minAge = this.maxAge - this.minAge >= 0 ? this.minAge : this.maxAge;
                  this.maxAge = this.maxAge - this.minAge >= 0 ? this.maxAge : this.minAge;
                  this.nYears = this.end - this.start + 1;


                  console.log('this.sectionVisible >> ' + this.sectionVisible);
                  this.yearFilter = [this.start,  
                                     this.end + 1];
                  // this.yearFilter = [this.start, this.end + 1];
                  this.ageFilter = [this.minAge, this.maxAge + 1];
                  
                  //---//
                  
                  this.changeByYear = this.yearDimension.filterRange(this.yearFilter)
                                        .group().reduceSum(function(d) { return d.s; });
                    // förändringsdata börjar vid 2015
                  
                  
                  this.changeByAge = this.ageDimension.filterRange(this.ageFilter).group()
                                          .reduceSum(function(d) { return d.s; });

                  this.change = this.xf.groupAll()
                                            .reduceSum(function(d) { return d.s; })
                                            .value();

                  this.increase = this.change >= 0;
                  this.decrease = !this.increase;
                  
//-----//

   for (var i = 0, len = this.widgets.length; i < len; i++) {
            document.getElementById('inactive').appendChild(document.getElementById(this.widgets[i]));
   }

   document.getElementById('widgetContainer').appendChild(document.getElementById(this.widgets[this.sectionVisible]));

//-----//

if(this.sectionVisible !== 4) {

               var allAges = this.changeByAge.all();

                  this.n0 = sumInterval(allAges, 0, 0);
                  this.n1_5 = sumInterval(allAges, 1, 5);
                  this.n6_15 = sumInterval(allAges, 6, 15);
                  this.n16_19 = sumInterval(allAges, 16, 19);
                  this.n20_64 = sumInterval(allAges, 20, 64);
                  this.n65_79 = sumInterval(allAges, 65, 79);
                  this.n80_100 = sumInterval(allAges, 80, 100);
                  this.nAll = sumInterval(allAges, 0, 100);
}
else {

               var allAges = this.changeByAge.all();
                  this.n15_19 = sumInterval(allAges, 15, 19);
                  this.n20_24 = sumInterval(allAges, 20, 24);
                  this.n25_34 = sumInterval(allAges, 25, 34);
                  this.n35_44 = sumInterval(allAges, 35, 44);
                  this.n45_54 = sumInterval(allAges, 45, 54);
                  this.n55_64 = sumInterval(allAges, 55, 64);
                  this.n65_69 = sumInterval(allAges, 65, 69);
                  this.n70_74 = sumInterval(allAges, 70, 74);
                  this.n75_79 = sumInterval(allAges, 75, 79);
                  this.n80_100 = sumInterval(allAges, 80, 100);
                  this.nAll = sumInterval(allAges, 0, 100);
 
}

//-----//


// HOUSING
if(this.sectionVisible === 4) {
housingTangle.setValues({ start: this.start, end: this.end, 
                  n15_19: this.n15_19, n20_24: this.n20_24,
                  n25_34: this.n25_34, n35_44: this.n35_44,
                  n45_54: this.n45_54, n55_64: this.n55_64,
                  n65_69: this.n65_69, n70_74: this.n70_74,
                  n75_79: this.n75_79, n80_100: this.n80_100,
                  nPeople: this.nAll
   });
}


// PRODUCTIVITY
if(this.sectionVisible === 6) {
productivityTangle.setValues({  start: this.start, end: this.end,
                                np: this.nAll, npp: this.n20_64
   });
}

// PRESCHOOL
if(this.sectionVisible === 1) {
preschoolTangle.setValues({ start: this.start, end: this.end, 
                            nPreschoolChildren: this.n1_5
   });
}


// PRIMARY SCHOOL
if(this.sectionVisible === 2) {
primaryschoolTangle.setValues({ start: this.start, end: this.end, 
                                nPrimaryschoolChildren: this.n6_15
   });
}


// CARE
if(this.sectionVisible === 5) {
careTangle.setValues({ start: this.start, end: this.end, 
                       n65_79: this.n65_79, n80_100: this.n80_100  
   });
}


// DEMOGRAPHY
if(this.sectionVisible === 0) {
demographyTangle.setValues({ start: this.start, end: this.end, 
                             n0: this.n0, n1_5: this.n1_5, n6_15:  
                             this.n6_15, n16_19: this.n16_19,  
                             n20_64: this.n20_64, n65_79: this.n65_79,  
                             n80_100: this.n80_100
   });
}

//------//

this.yearChart.update({ xmin: this.start, xmax: this.end });

this.ageChart.update({ xmin: this.minAge, xmax: this.maxAge });


//-----//


        }
    }
    
    var mainTangle = new Tangle(rootElement, model);

//-----//

    document.getElementById('gBrush').parentNode.appendChild(document.getElementById('gBrush'));

                    return json;
                })   // end of d3.json

//-------//





</script>






</body>
</html>
 
